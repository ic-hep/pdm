{% extends "dashboard.html" %}
{% block head %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.1/css/bootstrap.css" />
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/dataTables.bootstrap4.min.css" />
<style>
    span.oi-chevron-top, span.oi-chevron-bottom {cursor: pointer;}
</style>
{% endblock %}
{% block navjobsactive %}active{% endblock %}
{% block navjobsurl%}#{% endblock %}
{% block scripts %}
<script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap4.min.js"></script>
<script>
$(document).ready(function(){
    // placeholder spinning pdm image
    $("#jobs_table").DataTable({
        "columnDefs" : [{
            "className": "dt-center",
            "targets" : 0 ,
            "data": "img",
            "render" : function ( url, type, full) {
                         return `<img src=${full}/>`;
                       }
            }],
        "data": [['/static/images/pdm_animation.gif']]
    });

    $.ajax({
        url: "/web/js/jobs",
        type: "GET",
        cache: true,
        dataType: "json",
        error: function(request, status, error){
            console.warn(`Error getting users jobs!\nstatus: ${status}\nerror: ${error}\nrequest: ` + JSON.stringify(request));
            bootstrap_alert("Attention!", `Error getting users jobs! status: ${status} error: ${error}`, "alert-danger");
        },
        success: function(response, status, request){
            console.log("Successfully retrieved users jobs.");
            $("#jobs_table").DataTable().destroy();
            $("#jobs_table").empty(); // needed if columns change
            $("#jobs_table").DataTable(response);
            $($("#jobs_table").DataTable().table().container()).addClass("w-100");
        }
    });

    // Add event listener for opening and closing details
    $('#jobs_table').on('click', 'tbody tr td.details-control span.oi', function (){
        var details_control = $(this);
        var tr = details_control.closest('tr');
        var row = $("#jobs_table").DataTable().row(tr);
        details_control.toggleClass("oi-chevron-top text-danger oi-chevron-bottom text-primary")
        if ( row.child.isShown() ) {
            // This row is already open - close it
            row.child.hide();
            tr.removeClass('shown');
            return;
        }
        var job_id = tr.children("td.job_id").text();
        var loading_image = $("<img>", {src: "/static/images/pdm_animation.gif"})
        var subtable = $("<table>");
        row.child(loading_image).show();
        tr.addClass('shown');
        $.ajax({
            url: `/web/js/jobs/${job_id}/elements`,
            type: "GET",
            cache: true,
            dataType: "json",
            error: function(request, status, error){
                console.warn(`Error getting elements for job ${job_id}!\nstatus: ${status}\nerror: ${error}\nrequest: ` + JSON.stringify(request));
                bootstrap_alert("Attention!", `Error getting elements for job ${job_id}! status: ${status} error: ${error}`, "alert-danger");
            },
            success: function(response, status, request){
                console.log(`Successfully retrieved elements for job ${job_id}.`);
                subtable.DataTable(response);
                loading_image.replaceWith(subtable);
            }
        });
    });
});
</script>
{% endblock %}
{% block content %}
<table id="jobs_table" class="display compact w-100"></table>
{% endblock %}